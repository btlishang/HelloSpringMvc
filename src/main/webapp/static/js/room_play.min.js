var live={start:function(t,e,n){var o={userid:t,classroomid:e,courseid:n};$.ajax({type:"GET",url:"${webpath}/classroom/startlive",dataType:"json",data:o,success:function(e){$.longAlert({msg:"直播开启成功！",alert:{alertevent:function(){var e={};e.content='{"data":{"content":"","formUid":"'+t+'","num":1,"targetId":"'+liveid+'", "toUid":0},"isApp":false,"type":4}',sendMessageToChatroom("text",e),window.location.reload()}}})},error:function(e,t){}})},end:function(t,e,n){var o={userid:t,classroomid:e,courseid:n};$.ajax({type:"GET",url:"${webpath}/classroom/endlive",dataType:"json",data:o,success:function(e){0==e.code&&$.longAlert({msg:"直播已结束！",alert:{alertevent:function(){var e={};e.content='{"data":{"content":"","formUid":"'+t+'","num":1,"targetId":"'+liveid+'", "toUid":0},"isApp":false,"type":6}',sendMessageToChatroom("text",e),window.location.reload()}}})},error:function(e,t){}})}};function givegift(){var e={},t=$("#gift-pop .giftid").val();e.giftid=t,e.touid=userid,e.classroomid=classroomid,$.ajax({type:"GET",url:"/classroom/givegift",dataType:"json",data:e,success:function(e){$.longAlert({msg:"礼物赠送成功",alert:{alertevent:function(){var e={};e.content='{"data":{"content":"","formUid":"'+userid+'","num":1,"targetId":"'+liveid+'","giftId": "'+t+'", "toUid":0},"isApp":false,"type":3}',1==courseStatus&&sendMessageToChatroom("text",e)}}})},error:function(e,t){$.longAlert({msg:"网络连接失败，请重新尝试"})}})}function enterChatroom(){var t=(new Date).getTime();RongIMClient.getInstance().joinChatRoom(chatRoomId,count,{onSuccess:function(e){showResult("加入聊天室成功",null,t)},onError:function(e){showResult("加入聊天室失败",null,t)}})}function quitChatroom(){var t=(new Date).getTime();RongIMClient.getInstance().quitChatRoom(chatRoomId,{onSuccess:function(){showResult("退出聊天室成功",null,t)},onError:function(e){showResult("退出聊天室失败",null,t)}})}function sendMessageToChatroom(e,t){if((t=t).user=userinfo,"text"==e)var n=new RongIMLib.TextMessage(t);if("image"==e)n=new RongIMLib.ImageMessage(t);var i='<div class="livetv-im-item my"><img src="{avatar}" class="avatar"><div class="author">{name}</div><div class="cont">{content}</div></div>',s='<div class="livetv-im-item tip"><div class="cont">{content}</div></div>',o=RongIMLib.ConversationType.CHATROOM;(new Date).getTime();RongIMClient.getInstance().sendMessage(o,chatRoomId,n,{onSuccess:function(e){var t=e.content.user;switch(e.content.messageName){case"TextMessage":console.log(e.content.content);var n=JSON.parse(e.content.content);if(1==n.type)a=(a=(a=i.replace(/\{avatar}/g,t.portrait)).replace(/\{name}/g,t.name)).replace(/\{content}/g,n.data.content);else if(3==n.type)var o=getGiftName("g"+n.data.giftId),a='<div class="livetv-im-item tip"><div class="cont">'+t.name+"送给老师"+o+"</div></div>";else if(4==n.type)a=s.replace(/\{content}/g,"老师已开始直播");else if(6==n.type)a=s.replace(/\{content}/g,"直播已结束");$("#im-items").append(a);break;case"ImageMessage":a=(a=(a=i.replace(/\{avatar}/g,t.portrait)).replace(/\{name}/g,t.name)).replace(/\{content}/g,'<li><a href="'+e.content.imageUri+'" target="_blank"><img src="data:image/jpeg;base64,'+e.content.content+'" /></a>'),$("#im-items").append(a)}scrollBottom(),$("#text").val(""),showResult("发送聊天室消息成功",e)},onError:function(e,t){showResult("发送聊天室消息失败",t)}})}function chatroomInit(e,t,n){var o=e.appKey,a=e.token;RongIMLib.RongIMClient.init(o),RongIMClient.setConnectionStatusListener({onChanged:function(e){switch(e){case RongIMLib.ConnectionStatus.CONNECTED:console.log("链接成功"),enterChatroom();break;case RongIMLib.ConnectionStatus.CONNECTING:console.log("正在链接");break;case RongIMLib.ConnectionStatus.DISCONNECTED:console.log("断开连接");break;case RongIMLib.ConnectionStatus.KICKED_OFFLINE_BY_OTHER_CLIENT:console.log("其他设备登录");break;case RongIMLib.ConnectionStatus.DOMAIN_INCORRECT:console.log("域名不正确");break;case RongIMLib.ConnectionStatus.NETWORK_UNAVAILABLE:console.log("网络不可用")}}}),RongIMClient.setOnReceiveMessageListener({onReceived:function(e){var t='<div class="livetv-im-item"><img src="{avatar}" class="avatar"><div class="author">{name}</div><div class="cont">{content}</div></div>',n='<div class="livetv-im-item tip"><div class="cont">{content}</div></div>';console.log(e);var o=e.content.user;switch(e.messageType){case RongIMClient.MessageType.TextMessage:if(!liveConfig.isChat)return!1;var a=JSON.parse(e.content.content);if(1==a.type)c=(c=(c=t.replace(/\{avatar}/g,o.portrait||o.icon)).replace(/\{name}/g,o.name)).replace(/\{content}/g,a.data.content);else if(3==a.type)var i=getGiftName("g"+a.data.giftId),s=o.name+"送给老师"+i,c=n.replace(/\{content}/g,s);else if(4==a.type)c=n.replace(/\{content}/g,"老师开始直播");else if(5==a.type)c=n.replace(/\{content}/g,"老师离开直播间");else if(6==a.type)c=n.replace(/\{content}/g,"直播已结束");else if(10==a.type)c=n.replace(/\{content}/g,"老师进入");else if(11==a.type)c=n.replace(/\{content}/g,"教室已允许聊天！");else if(12==a.type)c=n.replace(/\{content}/g,"教室已禁止聊天！");else if(13==a.type)c=n.replace(/\{content}/g,"教室已允许发送图片！");else if(14==a.type)c=n.replace(/\{content}/g,"教室已禁止发送图片！");$("#im-items").append(c);break;case RongIMClient.MessageType.ImageMessage:if(!liveConfig.isChat||!liveConfig.isPic)return!1;s=e.content.content?"data:image/jpeg;base64,"+e.content.content:e.content.imageUri,c=(c=(c=t.replace(/\{avatar}/g,o.portrait||o.icon)).replace(/\{name}/g,o.name)).replace(/\{content}/g,'<li><a href="'+e.content.imageUri+'" target="_blank"><img src="'+s+'" /></a>'),$("#im-items").append(c)}scrollBottom()}}),RongIMClient.connect(a,{onSuccess:function(e){console.log("Connect successfully."+e)},onTokenIncorrect:function(){console.log("token无效")},onError:function(e){switch(e){case RongIMLib.ErrorCode.TIMEOUT:"超时";break;case RongIMLib.ConnectionState.UNACCEPTABLE_PAROTOCOL_VERSION:"不可接受的协议版本";break;case RongIMLib.ConnectionState.IDENTIFIER_REJECTED:"appkey不正确";break;case RongIMLib.ConnectionState.SERVER_UNAVAILABLE:"服务器不可用"}console.log(e)}})}function showResult(e,t){console.log(e+": "+JSON.stringify(t))}function uploadImgFile(e,c){$(e).change(function(){try{var e=this.files[0];if(!/image\/\w+/.test(e.type))return $.longAlert({msg:"请确保文件类型为图像类型"}),!1;var t=new FileReader;t.onload=function(){var s=new Image;s.src=t.result,s.onload=function(){var e=s.width,t=s.height;t<e&&(cw=e=225,ch=t=e/s.width*s.height,t<60&&(ch=t=60,e=t/s.height*s.width)),e<t&&(cw=e=120,ch=t=e/s.width*s.height,300<t&&(ch=300)),e==t&&(cw=e=ch=t=200);var n=document.createElement("canvas"),o=n.getContext("2d");$(n).attr({width:e,height:t}),o.drawImage(s,0,0,e,t);var a=n.toDataURL("image/jpeg",.5),i={url:s.src,base64:a,clearBase64:a.substr(a.indexOf(",")+1),suffix:a.substring(a.indexOf("/")+1,a.indexOf(";"))};c(i)}},t.readAsDataURL(this.files[0])}catch(e){_showMsg(e)}})}function getUrlParam(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),n=window.location.search.substr(1).match(t);return null!=n?unescape(n[2]):null}function scrollBottom(){$("#im-scroolbar").animate({scrollTop:$("#im-items").height()},300)}function dataURLtoBlob(e){for(var t=e.split(","),n=t[0].match(/:(.*?);/)[1],o=atob(t[1]),a=o.length,i=new Uint8Array(a);a--;)i[a]=o.charCodeAt(a);return new Blob([i],{type:n})}function getGiftName(id){return eval("giftList."+id)}$(function(){$(".roomplay-gift").on({mouseover:function(){$("#gift-pop").show()},mouseout:function(){isMouseLeaveOrEnter(event,this)&&$("#gift-pop").hide().removeClass("gift1").removeAttr("style")}}),$(".roomplay-gift .gift").on({mouseover:function(){var e=$(this).index(),t=$(this).data("content");$("#gift-pop").removeClass("gift1").css("left",58*e-40+"px"),$("#gift-pop .pic").attr("src",t[0]),$("#gift-pop .name").text(t[1]),$("#gift-pop .num").text(t[2]+"龙币"),$("#gift-pop .giftid").val(t[3])}})});